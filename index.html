<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css" />
    <script src="./routes.js" defer></script>
    <title>Flagcreator</title>
</head>
<body>
    <div class="navbar">
        <h1>FlagPlayDesigner</h1>
        <div class = "signupcontainer" id="authForm">
            <button id = "logInForm" class="open-button">Log in</button>
            <button id = "signUpForm">Sign up for free</button>
            <p class = "signOut" id="signedInText"></p>
            <button class = "signOut" id="signOutForm">Log out</button>
        </div>
    </div>
    <div class="allcontent">
    <div class="maincontent">
        <div class="canvascontainer">
            <div class="leftside">
                <div class="headlinecontainermiddle"><h2>Basic Routes</h2></div>
                <div class="routebuttoncontainer">
                    <div class ="buttoncontainer">
                        <h3>In Routes</h3>
                        <button id="slant">Slant</button>
                        <button id="hitch">Hitch</button>
                        <button id="fivein">In</button>
                        <button id="post">Post</button>
                        <button id="deepin">Deep In</button>
                        <button id="seam">Seam</button>
                    </div>
                    <div class ="buttoncontainer">
                        <h3>Out Routes</h3>
                        <button id="shoot">Shoot</button>
                        <button id="stop">Stop</button>
                        <button id="fiveout">Out</button>
                        <button id="corner">Corner</button>
                        <button id="deepout">Deep Out</button>
                        <button id="go">Go</button>
                    </div>
                </div>
                <div class="spacer"></div>
                <div class="headlinecontainer"><h2>Special Routes</h2></div>
                <div class="routebuttoncontainer">
                    <div class ="buttoncontainer">
                        <h3>In Routes</h3>
                        <button id="drag">Drag</button>
                        <button id="dig">Dig</button>
                        <button id="sit">Sit</button>
                        <button id="cornerpost">Corner Post</button>
                    </div>
                    <div class ="buttoncontainer">
                        <h3>Out Routes</h3>
                        <button id="wheel">Wheel</button>
                        <button id="comeback">Comeback</button>
                        <button id="whip">Whip</button>
                        <button id="postcorner">Post Corner</button>
                        <button id="shootfake">Shoot Fake</button> 
                        <button id="goallinefade">Goalline Fade</button>
                    </div>
                </div> 
                <div class="spacer"></div>
                <div class="headlinecontainer"><h2>Delete Routes</h2></div>
                <div class="routebuttoncontainer">
                    <div class ="buttoncontainer">
                        <button id="clearRoutes">Delete all routes</button>
                    </div>
                    <div class ="buttoncontainer">
                        <button id="clearCurrentRoute">Delete current route</button>
                    </div>
                </div>   
            </div>
            <div class="canvasdisplay">
                <div class="headlinecontainermiddle"><h2>Create your own play</h2></div>
                <canvas id = "canvas"></canvas>
                <script src="./canvas.js" defer></script>
                <div class="savecontainer">                            
                </div>
            </div>
            <div class="rightside">
                <div class="headlinecontainermiddle"><h2>Formations</h2></div>
                <div class="routebuttoncontainer">
                    <div class ="buttoncontainer">
                        <h3>Strong Left</h3>
                        <button id="spreadleft" class="formations">Spread Left</button>
                        <button class="formations" id="tightleft">Tight Left</button>
                        <button class="formations" id="bunchopenleft">Bunch Open Left</button>
                        <button class="formations" id="allbunchleft">All Bunch Left</button>
                        <button class="formations" id="tripsleft">Trips Left</button>
                    </div>
                    <div class ="buttoncontainer">
                        <h3>Strong Right</h3>
                        <button class="formations" id="spreadright">Spread Right</button>
                        <button class="formations" id="tightright">Tight Right</button>
                        <button class="formations" id="bunchopenright">Bunch Open Right</button>
                        <button class="formations" id="allbunchright">All Bunch Right</button>
                        <button class="formations" id="tripsright">Trips Right</button>
                    </div>
                </div>
                <div class="headlinecontainer"><h2>Custom Route</h2></div>
                <div class="routebuttoncontainer">
                    <div class ="buttoncontainer">
                        <button id="customRouteFinished">Finish Route</button>
                    </div>
                    <div class ="buttoncontainer">
                        <button id="hotroute">Hot Route</button>
                    </div>
                </div> 
                <div class="headlinecontainer"><h2>Save play</h2></div>
                <div class="routebuttoncontainer">
                    <div class ="buttoncontainer">
                        <input id="playName" type="text" placeholder="Enter playname">
                        <button id="savePlay" class="btn" >Save to playbook</button> 
                    </div>
                    <div class ="buttoncontainer">
                        <button id="saveToPicture">Save as picture</button>
                    </div>
                </div>
                <div class="headlinecontainer"><h2>Load play</h2></div>
                <div class="savebuttoncontainer">
                        <button id="loadPlay">Load play from playbook</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="popup" id="popup">
        <div class = "popupheader">
            <h2>Your Playbook</h2>
            <button id="close">X</button>
        </div>
        <div id="popup"class="gridcontainer" onclick="event.stopPropagation()">
        <div id="playContainer"></div>
        </div>
    </div>
    <div class="formPopup" id="popup">
        <div id="popup"class="formgridcontainer" onclick="event.stopPropagation()">
            <div class="form-container">
                <h1 class="formItems">Login</h1>
            
                <label class="formItems" for="email"><b>Email</b></label>
                <input class="formItems"type="email" placeholder="email" id="userEmail">
                
                <label class="formItems"for="psw"><b>Password</b></label>
                <input class="formItems"type="password" placeholder="password" id="userPassword">
                <input type="checkbox" id ="showPW"><p>Show Password</p>
            
                <button class="formItems"type="submit" id="logIn">Login</button>
                <button class="formItems"type="button" id="formClose">Close</button>
            </div>
        </div>
    </div>
    <div class="signUpformPopup" id="popup">
        <div id="popup"class="formgridcontainer" onclick="event.stopPropagation()">
            <div class="form-container">
                <h1 class="formItems">Signup</h1>
            
                <label class="formItems" for="email"><b>Email</b></label>
                <input class="formItems"type="email" placeholder="email" id="userEmailsu">
                
                <label class="formItems"for="psw"><b>Password</b></label>
                <input class="formItems"type="password" placeholder="password" id="userPasswordsu">
                <label class="formItems"for="psw"><b>Password best√§tigen</b></label>
                <input class="formItems"type="password" placeholder="password" id="userPasswordsu2">
                <input type="checkbox" id ="showPWsu"><p>Show Passwords</p>
            
                <button class="formItems"type="submit" id="signUp">Signup</button>
                <button class="formItems"type="button" id="signUpFormClose">Close</button>
            </div>
        </div>
    </div>
</div> 
    <script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
import { getDatabase, set, get, update, remove, ref, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB9kpQkrCGtr_9ksLVHHFrjheGsE1_WRQQ",
  authDomain: "flagplaycreator.firebaseapp.com",
  databaseURL: "https://flagplaycreator-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "flagplaycreator",
  storageBucket: "flagplaycreator.appspot.com",
  messagingSenderId: "63445078950",
  appId: "1:63445078950:web:a23c5ebec671660e63b567",
  measurementId: "G-CC9P0D6VTK"
};


// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase();
const auth = getAuth(app);
let userId = "empty";

// //Save play
let saveButton = document.querySelector("#savePlay");
let loadPlaybook = function (){
    const dbref = ref(db);
    if(userId === "empty"){
    console.log("Loading public playbook")
    get(child(dbref, "Plays/Public/"))
    .then((snapshot)=>{
        if(snapshot.exists()) {
            let plays = snapshot.val();
            let i = 0;
            for (const [key, value] of Object.entries(plays)) {
                let playImage = value.image;
                let playName = value.play;
                let mainDiv = document.getElementById("playContainer");
                let playDiv = document.createElement("div");
                playDiv.className="playList"
                playDiv.setAttribute("id", `playTile${i}`);
                playDiv.setAttribute("style", "cursor: pointer");
                playDiv.setAttribute("playName", playName)
                mainDiv.appendChild(playDiv);
                
                let img = new Image(200, 200);
                img.src = playImage;
                let src = document.getElementById(`playTile${i}`);
                src.appendChild(img);
                let title = document.createElement("p");
                title.className = "playTitle"
                let node = document.createTextNode(playName);
                title.appendChild(node);
                src.appendChild(title);
                i += 1

            }

        } else {
            alert("No play found.")
        }
    }
    )
    .catch((error)=>{
        alert(error)
    })
    } else {
    console.log("Loading private playbook")
    get(child(dbref, "Plays/" + userId + "/"))
    .then((snapshot)=>{
        if(snapshot.exists()) {
            let plays = snapshot.val();
            let i = 0;
            for (const [key, value] of Object.entries(plays)) {
                let playImage = value.image;
                let playName = value.play;
                let mainDiv = document.getElementById("playContainer");
                let playDiv = document.createElement("div");
                playDiv.className="playList"
                playDiv.setAttribute("id", `playTile${i}`);
                playDiv.setAttribute("style", "cursor: pointer");
                playDiv.setAttribute("playName", playName)
                mainDiv.appendChild(playDiv);
                
                let img = new Image(200, 200);
                img.src = playImage;
                let src = document.getElementById(`playTile${i}`);
                src.appendChild(img);
                let title = document.createElement("p");
                title.className = "playTitle"
                let node = document.createTextNode(playName);
                title.appendChild(node);
                src.appendChild(title);
                i += 1

            }

        } else {
            alert("No play found.")
        }
    }
    )
    .catch((error)=>{
        alert(error)
    })
    }
} 
saveButton.addEventListener("click", function() {
    storePlay();
});
let storePlay = function (){
    let playName = document.querySelector("#playName").value;
    console.log(userId)
    if(userId === "empty"){
        console.log("undefined uid");
        setbackborder();
        set(ref(db, "Plays/Public/" + playName),{
        play: playName,
        wr1: circles[0],
        wr2: circles[1],
        wr3: circles[2],
        wr4: circles[3],
        wr5: circles[4],
        cRoute1: customRoutes[0],
        cRoute2: customRoutes[1],
        cRoute3: customRoutes[2],
        cRoute4: customRoutes[3],
        cRoute5: customRoutes[4],
        c_height: canvas_height,
        c_width: canvas_width,
        image: canvas.toDataURL()
    })
    .then(()=>{
        alert("Play saved successfully.");
        let playTileContainer = document.querySelector("#playContainer");
        playTileContainer.remove();
        let gridParent = document.querySelector(".gridcontainer");
        let newPlayTileContainer = document.createElement("div");
        newPlayTileContainer.setAttribute("id", "playContainer");
        gridParent.appendChild(newPlayTileContainer);
        loadPlaybook();
    })
    .catch((error)=>{
        alert(error)
    }); 
    } else {
        console.log("defined uid")
        set(ref(db, "Plays/" + userId + "/" + playName),{
        play: playName,
        wr1: circles[0],
        wr2: circles[1],
        wr3: circles[2],
        wr4: circles[3],
        wr5: circles[4],
        cRoute1: customRoutes[0],
        cRoute2: customRoutes[1],
        cRoute3: customRoutes[2],
        cRoute4: customRoutes[3],
        cRoute5: customRoutes[4],
        c_height: canvas_height,
        c_width: canvas_width,
        image: canvas.toDataURL()
    })
    .then(()=>{
        alert("Play saved successfully.");
        //Here all created divs need to be cleared
        loadPlaybook();
    })
    .catch((error)=>{
        alert(error)
    });
    }
};


// Playbook Popup
let popup = document.getElementById("popup");

function openPopup(){
    popup.classList.add("open-popup");
}
let closePopup = function (){
    popup.classList.remove("open-popup");
}

let closeButton = document.getElementById("close");
closeButton.addEventListener("click", function() {
    closePopup()
})

popup.addEventListener("click", function() {
    closePopup()
})

// Login Form Popup
let loginForm = document.querySelector(".formPopup")
let loginFormButton = document.querySelector("#logInForm");
let formCloseButton = document.getElementById("formClose");
let pwCheckbox = document.getElementById("showPW");

function openLogInPopup(){
    loginForm.classList.add("open-popup");
}

function closeFormPopup(){
    loginForm.classList.remove("open-popup");
}

function pwReveal() {
  var x = document.getElementById("userPassword");
  if (x.type === "password") {
    x.type = "text";
  } else {
    x.type = "password";
  }
}

loginFormButton.addEventListener("click", function()  {openLogInPopup()})
formCloseButton.addEventListener("click", function() {closeFormPopup()})
loginForm.addEventListener("click", function() {closeFormPopup()})
pwCheckbox.addEventListener("click", function() {pwReveal()})


// Signup Form Popup
let signUpForm = document.querySelector(".signUpformPopup")
let signUpFormButton = document.querySelector("#signUpForm");
let signUpformCloseButton = document.getElementById("signUpFormClose");
let pwCheckboxsu = document.getElementById("showPWsu");

function opensignUpPopup(){
    signUpForm.classList.add("open-popup");
}

function closesignUpFormPopup(){
    signUpForm.classList.remove("open-popup");
}

function pwRevealsu() {
  let x = document.getElementById("userPasswordsu");
  let y = document.getElementById("userPasswordsu2");
  if (x.type === "password") {
    x.type = "text";
  } else {
    x.type = "password";
  }
  if (y.type === "password") {
    y.type = "text";
  } else {
    y.type = "password";
  }
}

signUpFormButton.addEventListener("click", function()  {opensignUpPopup()})
signUpformCloseButton.addEventListener("click", function() {closesignUpFormPopup()})
signUpForm.addEventListener("click", function() {closesignUpFormPopup()})
pwCheckboxsu.addEventListener("click", function() {pwRevealsu()})



//Open playbook
let loadButton = document.querySelector("#loadPlay");
loadButton.addEventListener("click", function() {
    openPopup();
    let elements = document.getElementsByClassName("playList");
    for (let i = 0; i < elements.length; i++){
        let play = elements[i].getAttribute("playName")
        elements[i].myParam = play;
        elements[i].addEventListener('click', loadPlay, false);
    }
    })



let loadPlay = function (evt){
    let playName = evt.currentTarget.myParam;
    const dbref = ref(db);
    if(userId === "empty"){
    get(child(dbref, "Plays/Public/" + playName))
    .then((snapshot)=>{
        if(snapshot.exists()) {
            circles[0] = snapshot.val().wr1;
            circles[1] = snapshot.val().wr2;
            circles[2] = snapshot.val().wr3;
            circles[3] = snapshot.val().wr4;
            circles[4] = snapshot.val().wr5;
            if (snapshot.val().cRoute1 == undefined){
                customRoutes[0] = customRoutes[0]
            } else {customRoutes[0] = snapshot.val().cRoute1};
            if (snapshot.val().cRoute2 == undefined){
                customRoutes[1] = customRoutes[1]
            } else {customRoutes[1] = snapshot.val().cRoute2}
            if (snapshot.val().cRoute3 == undefined){
                customRoutes[2] = customRoutes[2]
            } else {customRoutes[2] = snapshot.val().cRoute3}
            if (snapshot.val().cRoute4 == undefined){
                customRoutes[3] = customRoutes[3]
            } else {customRoutes[3] = snapshot.val().cRoute4}
            if (snapshot.val().cRoute5 == undefined){
                customRoutes[4] = customRoutes[4]
            } else {customRoutes[4] = snapshot.val().cRoute5}
            let og_height = snapshot.val().c_height;
            let og_width = snapshot.val().c_width;
            c.clearRect(0, 0, canvas_width, canvas_height);
            draw_playingfield();
            let counter = 0;
            for (let circle of circles) {
                currentCircleIndex = counter;
                selectedCircle = counter;
                circle.x = circle.x/og_width*canvas_width;
                circle.y = circle.y/og_height*canvas_height;
                circle.width = circle.width/og_width*canvas_width;
                circle.height = circle.height/og_height*canvas_height;
                c.fillStyle = circle.color;
                c.fillRect(circle.x, circle.y, circle.width, circle.height);
                c.strokeStyle = 'black';
                c.lineWidth = 4;
                c.strokeRect(circle.x, circle.y, circle.width, circle.height);
                paths[counter] = new Path2D();
                let savedRoute = circles[counter].assignedRoute;
                let newRoute = new Function(savedRoute);
                newRoute();
                counter += 1
            };
        } else {
            alert("No play found.")
        }
        closePopup();
    }
    )      
    .catch((error)=>{
        alert(error)
    })
    } else {
    get(child(dbref, "Plays/" + userId + "/" + playName))
    .then((snapshot)=>{
        if(snapshot.exists()) {
            circles[0] = snapshot.val().wr1;
            circles[1] = snapshot.val().wr2;
            circles[2] = snapshot.val().wr3;
            circles[3] = snapshot.val().wr4;
            circles[4] = snapshot.val().wr5;
            if (snapshot.val().cRoute1 == undefined){
                customRoutes[0] = customRoutes[0]
            } else {customRoutes[0] = snapshot.val().cRoute1};
            if (snapshot.val().cRoute2 == undefined){
                customRoutes[1] = customRoutes[1]
            } else {customRoutes[1] = snapshot.val().cRoute2}
            if (snapshot.val().cRoute3 == undefined){
                customRoutes[2] = customRoutes[2]
            } else {customRoutes[2] = snapshot.val().cRoute3}
            if (snapshot.val().cRoute4 == undefined){
                customRoutes[3] = customRoutes[3]
            } else {customRoutes[3] = snapshot.val().cRoute4}
            if (snapshot.val().cRoute5 == undefined){
                customRoutes[4] = customRoutes[4]
            } else {customRoutes[4] = snapshot.val().cRoute5}
            let og_height = snapshot.val().c_height;
            let og_width = snapshot.val().c_width;
            c.clearRect(0, 0, canvas_width, canvas_height);
            draw_playingfield();
            let counter = 0;
            for (let circle of circles) {
                currentCircleIndex = counter;
                selectedCircle = counter;
                circle.x = circle.x/og_width*canvas_width;
                circle.y = circle.y/og_height*canvas_height;
                circle.width = circle.width/og_width*canvas_width;
                circle.height = circle.height/og_height*canvas_height;
                c.fillStyle = circle.color;
                c.fillRect(circle.x, circle.y, circle.width, circle.height);
                c.strokeStyle = 'black';
                c.lineWidth = 4;
                c.strokeRect(circle.x, circle.y, circle.width, circle.height);
                paths[counter] = new Path2D();
                let savedRoute = circles[counter].assignedRoute;
                let newRoute = new Function(savedRoute);
                newRoute();
                counter += 1
            };
        } else {
            alert("No play found.")
        }
        closePopup();
    }
    )      
    .catch((error)=>{
        alert(error)
    })
    }

}
// Signout

const loginuserEmail = document.querySelector("#userEmail");
const loginuserPassword = document.querySelector("#userPassword");
const signupuserEmail = document.querySelector("#userEmailsu");
const signupuserPassword = document.querySelector("#userPasswordsu");
const signupuserPassword2 = document.querySelector("#userPasswordsu2");
const authForm = document.querySelector("#authForm")
const signUpButton = document.querySelector("#signUp");
const logInButton = document.querySelector("#logIn");
const signOutButton = document.querySelector("#signOutForm");

signOutButton.addEventListener("click", function() {signOutFunc()});
signUpButton.addEventListener("click", function() {userSignUp()});
logInButton.addEventListener("click",function () {userLogin()});

const userSignUp = async() => {
    
    const signUpEmail = signupuserEmail.value;
    const signUpPassword = signupuserPassword.value;
    const signUpPassword2 = signupuserPassword2.value;
    if (signUpPassword != signUpPassword2) {
        alert("Passwords are not matching. Try again!");
    } else {
    createUserWithEmailAndPassword(auth, signUpEmail, signUpPassword)
    .then((userCredential) => {
        const user = userCredential.user;
        console.log(user);
        alert("Your account has been created!");
        checkAuthState();

    }).catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.log(errorCode + errorMessage)
    })}
    closesignUpFormPopup();
}

const userLogin = async() => {
    
    const loginEmail = loginuserEmail.value;
    const loginPassword = loginuserPassword.value;
    signInWithEmailAndPassword(auth, loginEmail, loginPassword)
    .then((userCredential) => {
        const user = userCredential.user;
        userId = user.uid;
        document.getElementById("logInForm").style.display = "none";
        document.getElementById("signUpForm").style.display = "none";
        document.getElementById("signOutForm").style.display = "block";
        checkAuthState();

    }).catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.log(errorCode + errorMessage)
    })
    closeFormPopup();
}

const signOutFunc = async() => {
    await signOut(auth);
    checkAuthState();
}

const checkAuthState = async() => {
    onAuthStateChanged(auth, user => {
        if(user) {
            userId = user.uid;
            let userMail = user.email;
            console.log(userId);
            document.getElementById("logInForm").style.display = "none";
            document.getElementById("signUpForm").style.display = "none";
            document.getElementById("signOutForm").style.display = "block";
            document.getElementById("signedInText").innerText = "You are logged in as " + userMail;
            document.getElementById("signedInText").style.display = "flex";
            let playTileContainer = document.querySelector("#playContainer");
            playTileContainer.remove();
            let gridParent = document.querySelector(".gridcontainer");
            let newPlayTileContainer = document.createElement("div");
            newPlayTileContainer.setAttribute("id", "playContainer");
            gridParent.appendChild(newPlayTileContainer);
        }
        else{
            console.log("Not logged in");
            userId = "empty";
            document.getElementById("logInForm").style.display = "block";
            document.getElementById("signUpForm").style.display = "block";
            document.getElementById("signOutForm").style.display = "none";
            document.getElementById("signedInText").style.display = "none";
            let playTileContainer = document.querySelector("#playContainer");
            playTileContainer.remove();
            let gridParent = document.querySelector(".gridcontainer");
            let newPlayTileContainer = document.createElement("div");
            newPlayTileContainer.setAttribute("id", "playContainer");
            gridParent.appendChild(newPlayTileContainer);
        }
    })
    const dbref = ref(db);
    get(child(dbref, "Plays/Public/"))
    .then((snapshot)=>{
        loadPlaybook();
    }
    )
}

checkAuthState();


      </script>
</body>
</html>